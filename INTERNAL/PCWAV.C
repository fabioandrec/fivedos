#include <ClipApi.h>
#include <Dos.h>

// Ejecuta WAVs por el altavoz del PC

extern WORD _bcmp( LPBYTE, LPBYTE, WORD );
extern void sound( WORD wFrec );
extern void soundOn( void );
extern void soundOff( void );

extern void Delay( WORD );
extern void MicroDelay( unsigned long );

typedef struct
{
    BYTE    riff[ 4 ];  // la marca "RIFF"
    LONG    lTotBytes;  // n§ total de bytes
    char    WAVE[8];    // "WAVEfmt"
    LONG    lDummy;     //
    int     iFormat;    // Suele ser 1: PCM
    WORD    wCanals;    // 1:Mono, 2:Stereo
    DWORD   lFrec;      // frecuencia de muestreo
    LONG    lBytesSeg;  // bytes por segundo ( = frec si 8 bits )
    int     iAling;     // bytes por dato
    int     iBitSample; // bits por muestra
    LONG    lDummy2;    // la palabra "data"
    LONG    DataLen;
    BYTE    DataSec[];  // secuencia de muestras
} WAV;


//---------------------------------------------------------------------------//

static BYTE BaseTable[ 256 ] = { 0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x3F,0x3F,0x3F,0x3F,0x3F,0x3F,
                                 0x3F,0x3F,0x3F,0x3F,0x3F,0x3F,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,
                                 0x3D,0x3D,0x3D,0x3D,0x3D,0x3D,0x3D,0x3D,0x3D,0x3C,0x3C,0x3C,0x3C,0x3C,0x3C,0x3C,
                                 0x3C,0x3C,0x3C,0x3B,0x3B,0x3B,0x3B,0x3B,0x3B,0x3B,0x3B,0x3B,0x3B,0x3A,0x3A,0x3A,
                                 0x3A,0x3A,0x3A,0x3A,0x3A,0x3A,0x3A,0x39,0x39,0x39,0x39,0x39,0x39,0x39,0x39,0x39,
                                 0x39,0x38,0x38,0x38,0x38,0x38,0x38,0x38,0x38,0x37,0x37,0x37,0x37,0x37,0x36,0x36,
                                 0x36,0x36,0x35,0x35,0x35,0x35,0x34,0x34,0x34,0x33,0x33,0x32,0x32,0x31,0x31,0x30,
                                 0x30,0x2F,0x2E,0x2D,0x2C,0x2B,0x2A,0x29,0x28,0x27,0x26,0x25,0x24,0x23,0x22,0x21,
                                 0x20,0x1F,0x1E,0x1D,0x1C,0x1B,0x1A,0x19,0x18,0x17,0x16,0x15,0x14,0x13,0x12,0x11,
                                 0x11,0x10,0x10,0x0F,0x0F,0x0E,0x0E,0x0D,0x0D,0x0D,0x0C,0x0C,0x0C,0x0C,0x0B,0x0B,
                                 0x0B,0x0B,0x0A,0x0A,0x0A,0x0A,0x0A,0x09,0x09,0x09,0x09,0x09,0x09,0x09,0x09,0x09,
                                 0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x07,0x07,0x07,0x07,
                                 0x07,0x07,0x07,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x05,0x05,
                                 0x05,0x05,0x05,0x05,0x05,0x05,0x05,0x05,0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x04,
                                 0x04,0x04,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x02,0x02,0x02,0x02,
                                 0x02,0x02,0x02,0x02,0x02,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01
                               };

//---------------------------------------------------------------------------//

static void near AdjustTable ( LPBYTE pTable, WORD wTest )
{
    int i;
    for( i = 0; i < 256; i++ )
       pTable[ i ] = ( ( BaseTable[ i ] - 1 ) * wTest / 0x39 ) + 1;
}

//---------------------------------------------------------------------------//

void ExecWAV( WAV *v, WORD wWavLen )
{
    WORD wDelay, Volume;
    WORD i = 0;
    BYTE Table[ 256 ];

    if( _bcmp( v->riff, "RIFF", 4 ) )
        return;

    wDelay = 10000 / (WORD) ( (WORD) v->lFrec / (WORD) 10 );

    disable();

    outportb( 0x43, 0xB0 );
    outportb( 0x42, 0 );
    outportb( 0x42, 0 );

    outportb( 0x43, 0x90 );

    outportb( 0x61, inportb( 0x61 ) | 0x03 );

    if( v->lFrec <= 4800 )
    {
        Volume = 248;
    }
    if( v->lFrec <= 11025 )
    {
        Volume = 108;
    }
    else if( v->lFrec <=  22050 )
    {
        Volume = 54;
    }
    else
    {
        Volume = 27;
    }

    AdjustTable( Table, Volume ); // 1193182 / v->lFrec );

    while ( i < wWavLen - sizeof( WAV ) )
    {
        outportb( 0x42, Table[ v->DataSec[ i++ ] ] );
        MicroDelay( wDelay );
    }

    outportb( 0x43, 0x36 );
    outportb( 0x40, 0 );
    outportb( 0x40, 0 );
    outportb( 0x61, inportb( 0x61 ) & 0xFC );
    enable();

    _retni( wDelay );
}

//---------------------------------------------------------------------------//

CLIPPER PlayPCWav( void ) // cWav, nRetardo
{
   ExecWAV( (WAV*) _parc( 1 ), _parclen( 1 ) );
}

//---------------------------------------------------------------------------//
