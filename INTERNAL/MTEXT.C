#pragma inline

#include <dos.h>
#include <ClipApi.h>

LPBYTE TextVideo( void );
LPBYTE GraphVideo( void );
WORD SegmentToSel( WORD );


static WORD wRowOld = 0, wColOld = 0;
static BYTE Back[ 6 ];
static BYTE bChars[ 6 ] = { 199, 200, 201, 202, 203, 204 };
static BOOL bInit = 0, bOnOff = 0;
static BYTE bRow = 0, bCol = 0;  // Coordenadas de texto del cursor del rat¢n
static WORD wLineWidth;          // Ancho de la pantalla multiplicado por 2
static BYTE bCharHeigth = 0;     // Alto de una celdilla de caracter
static BOOL bLeft, bCenter, bRight;
static WORD wKLeft, wKCenter, wKRight;
static BYTE bOffs;
static BOOL bWorking = FALSE;
static BOOL bEga = 0;
static BOOL bInstaled;
static WORD wNewRow = 0, wNewCol = 0, wNewButton = 0;

static BYTE Arrow[ 3 ][ 16 ] = {
                                {  0x00,     // 00000000
                                   0x40,     // 01000000
                                   0x60,     // 01100000
                                   0x70,     // 01110000
                                   0x78,     // 01111000
                                   0x7C,     // 01111100
                                   0x7E,     // 01111110
                                   0x7F,     // 01111111
                                   0x7F,     // 01111111
                                   0x7F,     // 01111111
                                   0x7C,     // 01111100
                                   0x66,     // 01100110
                                   0x46,     // 01000110
                                   0x03,     // 00000011
                                   0x03,     // 00000011
                                   0x00 },   // 00000000
                                {  0x00,     // 00000000
                                   0x00,     // 00000000
                                   0x00,     // 00000000
                                   0x00,     // 00000000
                                   0x00,     // 00000000
                                   0x00,     // 00000000
                                   0x00,     // 00000000
                                   0x00,     // 00000000
                                   0x80,     // 10000000
                                   0xC0,     // 11000000
                                   0x00,     // 00000000
                                   0x00,     // 00000000
                                   0x00,     // 00000000
                                   0x00,     // 00000000
                                   0x00,     // 00000000
                                   0x00 },   // 00000000
                                 { 0x00,     // 00000000
                                   0x00,     // 00000000
                                   0x00,     // 00000000
                                   0x00,     // 00000000
                                   0x00,     // 00000000
                                   0x00,     // 00000000
                                   0x00,     // 00000000
                                   0x00,     // 00000000
                                   0x00,     // 00000000
                                   0x00,     // 00000000
                                   0x00,     // 00000000
                                   0x00,     // 00000000
                                   0x00,     // 00000000
                                   0x00,     // 00000000
                                   0x00,     // 00000000
                                   0x00 } }; // 00000000

static BYTE ArrowMask[ 3 ][ 16 ] = { {
                                    0xC0,    // 11000000
                                    0xE0,    // 11100000
                                    0xF0,    // 11110000
                                    0xF8,    // 11111000
                                    0xFC,    // 11111100
                                    0xFE,    // 11111110
                                    0xFF,    // 11111111
                                    0xFF,    // 11111111
                                    0xFF,    // 11111111
                                    0xFF,    // 11111111
                                    0xFF,    // 11111111
                                    0xFF,    // 11111111
                                    0xEF,    // 11101111
                                    0xE7,    // 11100111
                                    0x07,    // 00000111
                                    0x03 },  // 00000011
                                  { 0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x80,    // 10000000
                                    0xC0,    // 11000000
                                    0xE0,    // 11100000
                                    0xE0,    // 11100000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x80,    // 10000000
                                    0x80,    // 10000000
                                    0x80 },  // 10000000
                                  { 0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00 } } ; // 00000000


static BYTE Clock[ 3 ][ 16 ] = {
                                  { 0x00,    // 00000000
                                    0x7F,    // 01111111
                                    0x60,    // 01100000
                                    0x61,    // 01100001
                                    0x32,    // 00110010
                                    0x35,    // 00110101
                                    0x1A,    // 00011010
                                    0x0F,    // 00001111
                                    0x0F,    // 00001111
                                    0x18,    // 00011000
                                    0x30,    // 00110000
                                    0x30,    // 00110000
                                    0x62,    // 01100010
                                    0x65,    // 01100101
                                    0x7F,    // 01111111
                                    0x00 },  // 00000000
                                  { 0x00,    // 00000000
                                    0xFC,    // 11111100
                                    0x2C,    // 00101100
                                    0x5C,    // 01011100
                                    0xB8,    // 10111000
                                    0x58,    // 01011000
                                    0xB0,    // 10110000
                                    0xE0,    // 11100000
                                    0xE0,    // 11100000
                                    0x30,    // 00110000
                                    0x18,    // 00011000
                                    0x18,    // 00011000
                                    0x8C,    // 10001100
                                    0x4C,    // 01001100
                                    0xFC,    // 11111100
                                    0x00 },  // 00000000
                                  { 0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00 }}; // 00000000

static BYTE ClockMask[ 3 ][ 16 ] = {
                                  { 0xFF,    // 11111111
                                    0xFF,    // 11111111
                                    0xFF,    // 11111111
                                    0xFE,    // 11111110
                                    0x7D,    // 01111101
                                    0x7A,    // 01111010
                                    0x3D,    // 00111101
                                    0x1F,    // 00011111
                                    0x1F,    // 00011111
                                    0x3F,    // 00111111
                                    0x7F,    // 01111111
                                    0x7F,    // 01111111
                                    0xFD,    // 11111101
                                    0xFA,    // 11111010
                                    0xFF,    // 11111111
                                    0xFF },  // 11111111
                                  { 0xFE,    // 11111110
                                    0xFE,    // 11111110
                                    0xDE,    // 11011110
                                    0xBE,    // 10111110
                                    0x7C,    // 01111100
                                    0xBC,    // 10111100
                                    0x78,    // 01111000
                                    0xF0,    // 11110000
                                    0xF0,    // 11110000
                                    0xF8,    // 11111000
                                    0xFC,    // 11111100
                                    0xFC,    // 11111100
                                    0x7E,    // 01111110
                                    0xBE,    // 10111110
                                    0xFE,    // 11111110
                                    0xFE },  // 11111110
                                  { 0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00 }}; // 00000000

static BYTE DownArrow[ 3 ][ 16 ] = {
                                  { 0x00,    // 00000000
                                    0x0C,    // 00001100
                                    0x1E,    // 00011110
                                    0x3F,    // 00111111
                                    0x7F,    // 01111111
                                    0x0C,    // 00001100
                                    0x0C,    // 00001100
                                    0x0C,    // 00001100
                                    0x0C,    // 00001100
                                    0x7F,    // 01111111
                                    0x3F,    // 00111111
                                    0x1E,    // 00011110
                                    0x0C,    // 00001100
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00 },  // 00000000

                                  { 0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x80,    // 10000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x80,    // 10000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00 },  // 00000000

                                  { 0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00 }}; // 00000000

static BYTE DownMask[ 3 ][ 16 ] = {
                                  { 0x0C,    // 00001100
                                    0x1E,    // 00011110
                                    0x3F,    // 00111111
                                    0x7F,    // 01111111
                                    0xFF,    // 11111111
                                    0xFF,    // 11111111
                                    0x1E,    // 00011110
                                    0x1E,    // 00011110
                                    0xFF,    // 11111111
                                    0xFF,    // 11111111
                                    0x7F,    // 01111111
                                    0x3F,    // 00111111
                                    0x1E,    // 00011110
                                    0x0C,    // 00001100
                                    0x00,    // 00000000
                                    0x00 },  // 00000000
                                  { 0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x80,    // 10000000
                                    0xC0,    // 11000000
                                    0x80,    // 10000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x80,    // 10000000
                                    0xC0,    // 11000000
                                    0x80,    // 10000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00 },  // 00000000
                                  { 0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00 }}; // 00000000

static BYTE CrossArrow[ 3 ][ 16 ] = {
                                  { 0x00,    // 00000000
                                    0x01,    // 00000001
                                    0x03,    // 00000011
                                    0x07,    // 00000111
                                    0x01,    // 00000001
                                    0x11,    // 00010001
                                    0x31,    // 00110001
                                    0x7F,    // 01111111
                                    0x7F,    // 01111111
                                    0x31,    // 00110001
                                    0x11,    // 00010001
                                    0x01,    // 00000001
                                    0x07,    // 00000111
                                    0x03,    // 00000011
                                    0x01,    // 00000001
                                    0x00 },  // 00000000

                                  { 0x00,    // 00000000
                                    0x80,    // 10000000
                                    0xC0,    // 11000000
                                    0xE0,    // 11100000
                                    0x80,    // 10000000
                                    0x88,    // 10001000
                                    0x8C,    // 10001100
                                    0xFE,    // 11111110
                                    0xFE,    // 11111110
                                    0x8C,    // 10001100
                                    0x88,    // 10001000
                                    0x80,    // 10000000
                                    0xE0,    // 11100000
                                    0xC0,    // 11000000
                                    0x80,    // 10000000
                                    0x00 },  // 00000000

                                  { 0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00 }}; // 00000000

static BYTE CrossMask[ 3 ][ 16 ] = {
                                  { 0x01,    // 00000001
                                    0x03,    // 00000011
                                    0x07,    // 00000111
                                    0x0F,    // 00001111
                                    0x1F,    // 00011111
                                    0x3B,    // 00111011
                                    0x7F,    // 01111111
                                    0xFF,    // 11111111
                                    0xFF,    // 11111111
                                    0x7F,    // 01111111
                                    0x3B,    // 00111011
                                    0x1F,    // 00011111
                                    0x0F,    // 00001111
                                    0x07,    // 00000111
                                    0x03,    // 00000011
                                    0x01 },  // 00000001

                                  { 0x80,    // 10000000
                                    0xC0,    // 11000000
                                    0xE0,    // 11100000
                                    0xF0,    // 11110000
                                    0xF8,    // 11111000
                                    0xDC,    // 11011100
                                    0xFE,    // 11111110
                                    0xFF,    // 11111111
                                    0xFF,    // 11111111
                                    0xFE,    // 11111110
                                    0xDC,    // 11011100
                                    0xF8,    // 11111000
                                    0xF0,    // 11110000
                                    0xE0,    // 11100000
                                    0xC0,    // 11000000
                                    0x80 },  // 10000000

                                  { 0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00 }}; // 00000000

static BYTE HandPoint[ 3 ][ 16 ] = {
                                  { 0x0C,    // 00001100
                                    0x1E,    // 00011110
                                    0x1E,    // 00011110
                                    0x1F,    // 00011111
                                    0x1D,    // 00011101
                                    0x6D,    // 01101101
                                    0xED,    // 11101101
                                    0xFD,    // 11111101
                                    0xFF,    // 11111111
                                    0xFF,    // 11111111
                                    0xFF,    // 11111111
                                    0x7F,    // 01111111
                                    0x3F,    // 00111111
                                    0x1F,    // 00011111
                                    0x1F,    // 00011111
                                    0x0F },  // 00001111

                                  { 0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0xFE,    // 11111110
                                    0xB7,    // 10110111
                                    0xB7,    // 10110111
                                    0xB7,    // 10110111
                                    0xB7,    // 10110111
                                    0xFF,    // 11111111
                                    0xFF,    // 11111111
                                    0xFF,    // 11111111
                                    0xFE,    // 11111110
                                    0xFE,    // 11111110
                                    0xFE,    // 11111110
                                    0xFE,    // 11111110
                                    0xFE },  // 11111110

                                  { 0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00 }}; // 00000000


static BYTE HandMask[ 3 ][ 16 ] = {
                                  { 0x0C,    // 00001100
                                    0x1E,    // 00011110
                                    0x1E,    // 00011110
                                    0x1F,    // 00011111
                                    0x1D,    // 00011101
                                    0x6D,    // 01101101
                                    0xED,    // 11101101
                                    0xFD,    // 11111101
                                    0xFF,    // 11111111
                                    0xFF,    // 11111111
                                    0xFF,    // 11111111
                                    0x7F,    // 01111111
                                    0x3F,    // 00111111
                                    0x1F,    // 00011111
                                    0x1F,    // 00011111
                                    0x0F },  // 00001111

                                  { 0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0xFE,    // 11111110
                                    0xB7,    // 10110111
                                    0xB7,    // 10110111
                                    0xB7,    // 10110111
                                    0xB7,    // 10110111
                                    0xFF,    // 11111111
                                    0xFF,    // 11111111
                                    0xFF,    // 11111111
                                    0xFE,    // 11111110
                                    0xFE,    // 11111110
                                    0xFE,    // 11111110
                                    0xFE,    // 11111110
                                    0xFE },  // 11111110

                                  { 0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00 }}; // 00000000

static BYTE SizeNWSE[ 3 ][ 16 ] = {
                                  { 0x00,    // 00000000
                                    0x7E,    // 01111110
                                    0x7C,    // 01111100
                                    0x7C,    // 01111100
                                    0x7E,    // 01111110
                                    0x4F,    // 01001111
                                    0x07,    // 00000111
                                    0x03,    // 00000011
                                    0x01,    // 00000001
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00 },  // 00000000

                                  { 0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x80,    // 10000000
                                    0xC0,    // 11000000
                                    0xE0,    // 11100000
                                    0xF2,    // 11110010
                                    0x7E,    // 01111110
                                    0x3E,    // 00111110
                                    0x3E,    // 00111110
                                    0x7E,    // 01111110
                                    0x00,    // 00000000
                                    0x00 },  // 00000000

                                  { 0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00 }}; // 00000000


static BYTE SizeNWSEMask[ 3 ][ 16 ] = {
                                  { 0xFE,    // 11111110
                                    0xFE,    // 11111110
                                    0xFC,    // 11111100
                                    0xFC,    // 11111100
                                    0xFE,    // 11111110
                                    0xCF,    // 11001111
                                    0x07,    // 00000111
                                    0x03,    // 00000011
                                    0x01,    // 00000001
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00 },  // 00000000

                                  { 0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x80,    // 10000000
                                    0xC0,    // 11000000
                                    0xE0,    // 11100000
                                    0xF3,    // 11110011
                                    0x7F,    // 01111111
                                    0x3F,    // 00111111
                                    0x3F,    // 00111111
                                    0x7F,    // 01111111
                                    0x7F,    // 01111111
                                    0x00 },  // 00000000

                                  { 0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00,    // 00000000
                                    0x00 }}; // 00000000

static LPBYTE pCursors[] = { ( LPBYTE ) Arrow,
                             ( LPBYTE ) Clock,
                             ( LPBYTE ) DownArrow,
                             ( LPBYTE ) CrossArrow,
                             ( LPBYTE ) HandPoint,
                             ( LPBYTE ) SizeNWSE };

static LPBYTE pMasks[]   = { ( LPBYTE ) ArrowMask,
                             ( LPBYTE ) ClockMask,
                             ( LPBYTE ) DownMask,
                             ( LPBYTE ) CrossMask,
                             ( LPBYTE ) HandMask,
                             ( LPBYTE ) SizeNWSEMask };


static BYTE pHots[ 6 ][ 2 ] = { {  8,  8 },
                                { 56, 56 },
                                { 48, 32 },
                                { 64, 64 },
                                {  0, 40 },
                                { 8, 8 }
                              };

static BYTE   bCursor = 0;


//---------------------------------------------------------------------------//

BYTE bMouseCursor( void ) { return bCursor; }

//---------------------------------------------------------------------------//

BOOL bIsEga( void )
{
   _AH = 0x12;
   _BX = 0xFF10;
   asm int 0x10;

   return ( _BX != 0xFF10 );
}

// ----------------------------------------------------------------------------

void KeyStuff( unsigned int uiKey )
{
   unsigned int uiTail        = peek( 0, 0x041C );
   unsigned int uiBufferStart = peek( 0, 0x0480 );
   unsigned int uiBufferEnd   = peek( 0, 0x0482 );

   poke( 0, 0x0400 + uiTail, uiKey );
   uiTail += 2;
   poke( 0, 0x041C, ( uiTail >= uiBufferEnd ) ? uiBufferStart: uiTail );
}

//---------------------------------------------------------------------------//

static void FontBegin( void )  // Copia el font a RAM
{
   disable();
   outport( 0x3C4, 0x0402 );
   outport( 0x3C4, 0x0704 );
   outport( 0x3C4, 0x0300 );

   outport( 0x3CE, 0x0204 );
   outport( 0x3CE, 0x0005 );
   outport( 0x3CE, 0x0006 );
   enable();
}

// ----------------------------------------------------------------------------

static void FontEnd( void )  // Copia el font a la tarjeta
{
   disable();
   outport( 0x3C4, 0x0302 );
   outport( 0x3C4, 0x0304 );
   outport( 0x3C4, 0x0300 );

   outport( 0x3CE, 0x0004 );
   outport( 0x3CE, 0x1005 );
   outport( 0x3CE, 0x0E06 );
   enable();
}

// ----------------------------------------------------------------------------

// Standard Stack Frame
#pragma option -k
static BYTE bCharScanLines( void )
{
   _AX = 0x1130;
   _BH = 0;
   asm int 0x10;  // Ojo que toca BP

   return _CX;
}
#pragma option -k-

// ----------------------------------------------------------------------------

void MouseReset( void )
{
   _AX = 0;
   asm int 0x33;
}

//---------------------------------------------------------------------------//

// Enable FastCall and optimizations
#pragma option -pr -O2

//---------------------------------------------------------------------------//

static int near abs( int Number )
{
   asm mov ax, Number;

   if( _AX > 0x7FFF )
   {
      asm neg ax;
   }
   
   return _AX;
}

//---------------------------------------------------------------------------//

static void near CopyCharDef( BYTE bDest, BYTE bOrigin )
{
   char * pFont = GraphVideo();

   _bcopy( pFont + bDest * 32, pFont + bOrigin * 32, bCharHeigth );
}

//---------------------------------------------------------------------------//
/***********OLD
static void near ChangeDef( BYTE bDest, LPBYTE pbBlock, LPBYTE pbMask, BYTE bStart,
                       BYTE bEnd )
{
   LPBYTE pFont = GraphVideo() + bDest * 32;
   WORD  b;

      for( b = bStart; b <= bEnd; b++ )
         pFont[ b ] = ( pFont[ b ] &
            pbMask[ b - bStart + ( ( bEnd < ( bCharHeigth - 1 ) ) ? ( ( bCharHeigth - 1 ) - bEnd ): 0 ) ] )
            | pbBlock[ b - bStart + ( ( bEnd < ( bCharHeigth - 1 ) ) ? ( ( bCharHeigth - 1 ) - bEnd ): 0 )];
}
****************/

static void near ChangeDef( BYTE bDest, LPBYTE pbBlock, LPBYTE pbMask, BYTE bStart,
                       BYTE bEnd )
{
   LPBYTE pFont = GraphVideo() + bDest * 32;
   WORD  b;
   WORD  wEnd  = ( ( bEnd < ( bCharHeigth - 1 ) ) ? ( ( bCharHeigth - 1 ) - bEnd ): 0 );
   pbMask  += wEnd;
   pbBlock += wEnd;

   pFont += bStart;

   for( b = bStart; b <= bEnd; b++ )
        * pFont = ( * pFont++ & * pbMask++ ) | * pbBlock++;
}



//---------------------------------------------------------------------------//

static BYTE near bPower( BYTE bTimes )
{
   BYTE bResult = 1, b;

   for( b = 0; b < bTimes; b++ )
      bResult *= 2;

   return bResult;
}

//---------------------------------------------------------------------------//

// Disable FastCall: C Calling convention
#pragma option -p-

//---------------------------------------------------------------------------//

void SetChar( LPBYTE pFontDef )
{
    if( bCharHeigth == 0 )
        bCharHeigth = bCharScanLines();

    FontBegin();

    _bcopy( GraphVideo() + pFontDef[ 0 ] * 32,
            pFontDef + 1, bCharHeigth );

    FontEnd();

}

//---------------------------------------------------------------------------//
/****
void SetCharMaps( BYTE map0, BYTE map1)
{
    BYTE bFlags = ( map0 & 3 ) + ( ( map0 & 4 ) << 2 ) +
                  ( ( map1 & 3 ) << 2 ) + ( ( map1 & 4 ) << 3 );
    asm {
            mov ax, 0x1103 // Programar Character-Map-Select-Register
            mov bl, bFlags
            int 0x10
        }
}
***/

//---------------------------------------------------------------------------//

static void CursorMix( BYTE bVer, BYTE bHor, LPBYTE pOld, LPBYTE pNew,
                       BOOL bWaitRetrace  )
{
   BYTE Cursor[ 3 ][ 16 ];
   BYTE Mask[ 3 ][ 16 ];

   BYTE b, bRest1, bRest2, bShift = bPower( bHor ) - 1;
   
   _bcopy( ( LPBYTE ) Cursor, ( LPBYTE ) pCursors[ bCursor ], 48 );
   _bcopy( ( LPBYTE ) Mask, ( LPBYTE ) pMasks[ bCursor ], 48 );

   for( b = 0; b < bCharHeigth; b++ )
   {
      bRest1 = ( Cursor[ 0 ][ b ] & bShift ) << ( 8 - bHor );
      bRest2 = ( Cursor[ 1 ][ b ] & bShift ) << ( 8 - bHor );
      Cursor[ 0 ][ b ] >>= bHor;
      Cursor[ 1 ][ b ] >>= bHor;
      Cursor[ 2 ][ b ] >>= bHor;
      Cursor[ 1 ][ b ] |= bRest1;
      Cursor[ 2 ][ b ] |= bRest2;

      bRest1 = ( Mask[ 0 ][ b ] & bShift ) << ( 8 - bHor );
      bRest2 = ( Mask[ 1 ][ b ] & bShift ) << ( 8 - bHor );
      Mask[ 0 ][ b ] >>= bHor;
      Mask[ 0 ][ b ] = ~Mask[ 0 ][ b ];
      Mask[ 1 ][ b ] >>= bHor;
      Mask[ 1 ][ b ] |= bRest1;
      Mask[ 1 ][ b ] = ~Mask[ 1 ][ b ];
      Mask[ 2 ][ b ] >>= bHor;
      Mask[ 2 ][ b ] |= bRest2;
      Mask[ 2 ][ b ] = ~Mask[ 2 ][ b ];
   }

   disable();

   if( bWaitRetrace )
   {
       while( !( ( inport( 0x3DA ) & 8 ) == 8 ) );
       while( !( ( inport( 0x3DA ) & 8 ) == 0 ) );
   }

   if( !( pOld == 0 ) )
   {
        pOld[ 0 ] = Back[ 0 ];
        pOld[ 2 ] = Back[ 1 ];
        pOld[ 4 ] = Back[ 2 ];
        pOld += wLineWidth;
        pOld[ 0 ] = Back[ 3 ];
        pOld[ 2 ] = Back[ 4 ];
        pOld[ 4 ] = Back[ 5 ];
   }

   Back[ 0 ] = pNew[ 0 ];
   Back[ 1 ] = pNew[ 2 ];
   Back[ 2 ] = pNew[ 4 ];
   pNew += wLineWidth;
   Back[ 3 ] = pNew[ 0 ];
   Back[ 4 ] = pNew[ 2 ];
   Back[ 5 ] = pNew[ 4 ];

   enable();

   FontBegin();

   disable();

   CopyCharDef( bChars[ 0 ], Back[ 0 ] );
   CopyCharDef( bChars[ 1 ], Back[ 1 ] );
   CopyCharDef( bChars[ 2 ], Back[ 2 ] );

   ChangeDef( bChars[ 0 ], Cursor[ 0 ], Mask[ 0 ], bVer, bCharHeigth - 1 );
   ChangeDef( bChars[ 1 ], Cursor[ 1 ], Mask[ 1 ], bVer, bCharHeigth - 1 );
   ChangeDef( bChars[ 2 ], Cursor[ 2 ], Mask[ 2 ], bVer, bCharHeigth - 1 );

   if( bVer )
   {
       CopyCharDef( bChars[ 3 ], Back[ 3 ] );
       CopyCharDef( bChars[ 4 ], Back[ 4 ] );
       CopyCharDef( bChars[ 5 ], Back[ 5 ] );

       ChangeDef( bChars[ 3 ], Cursor[ 0 ], Mask[ 0 ], 0, bVer - 1 );
       ChangeDef( bChars[ 4 ], Cursor[ 1 ], Mask[ 1 ], 0, bVer - 1 );
       ChangeDef( bChars[ 5 ], Cursor[ 2 ], Mask[ 2 ], 0, bVer - 1 );
   }

   enable();

   FontEnd();

   if( bVer )
   {
        pNew[ 0 ] = bChars[ 3 ];
        pNew[ 2 ] = bChars[ 4 ];
        pNew[ 4 ] = bChars[ 5 ];
   }
   pNew -= wLineWidth;
   pNew[ 0 ] = bChars[ 0 ];
   pNew[ 2 ] = bChars[ 1 ];
   pNew[ 4 ] = bChars[ 2 ];

}

// ----------------------------------------------------------------------------

static void _saveregs TextMode( void )
{
   WORD  wButton  = _BX;
   WORD  wRow     = _DX;
   WORD  wCol     = _CX;
   int   iMickHor = _SI;
   int   iMickVer = _DI;
   LPBYTE pVideo;
   BYTE  bVer, bHor;

   asm mov  ax, DGROUP;
   asm mov  ds, ax;

   wNewRow = wRow;
   wNewCol = wCol;
   wNewButton = wButton;
   

   if( ! bWorking )
   {
      bWorking = TRUE;

      if( bOnOff && ( iMickHor || iMickVer ) && bEga )
      {
         bOffs  = ( bOffs ) ? ( bOffs - 1 ): 0;

         if( ! bOffs )
         {
            pVideo = TextVideo();

            asm {
                    mov ax, 0x000B
                    int 0x33
                }

            bOnOff = FALSE;

            wRow = IF( wRow >= pHots[ bCursor ][ 0 ], wRow - pHots[ bCursor ][ 0 ], 0 );
            wCol = IF( wCol >= pHots[ bCursor ][ 1 ], wCol - pHots[ bCursor ][ 1 ], 0 );

            bVer  = ( wRow / 8 ) % bCharHeigth;
            bHor  = ( wCol / 8 ) % 9;
            wRow /= ( 8 * bCharHeigth );
            wCol /= ( 8 * 9 );
            
            CursorMix( bVer, bHor,
                       pVideo + ( wRowOld * wLineWidth ) + ( wColOld * 2 ),
                       pVideo + ( wRow * wLineWidth ) + ( wCol * 2 ),
                       ( abs( iMickHor ) + abs( iMickVer ) ) < 6 );
            
            wRowOld = wRow;
            wColOld = wCol;

            bOnOff = TRUE;

         }
      }
      bWorking = FALSE;
   }
}

//----------------------------------------------------------------------------

void MouseInit( BYTE bNormalMouse )
{
   WORD wScreenHeigth = 25;  // peekb( 0, 0x484 );
   WORD wScreenWidth  = 79;  // peek( 0, 0x44A ) - 1;
   WORD wHorRes, wVerRes;

   bEga        = bIsEga() && ! bNormalMouse;
   bInit       = TRUE;
   wLineWidth  = ( wScreenWidth + 1 ) * 2;
   bCharHeigth = bCharScanLines();

   wHorRes = wScreenWidth * 8 * 9;
   wVerRes = ( wScreenHeigth * 8 * bCharHeigth ) - 1; //  + 50;  // 8

   _AX = 0;
   asm int 0x33;
   bInstaled = _AX;

   if( bInstaled && bEga )
   {
      _AX = 0xF;
      _CX = 1;                    // Horizontal sensibility
      _DX = 1;                    // Vertical sensibility
      asm int 0x33;

      _CX =   0;                  // Defines Horizontal resolution
      _DX = wHorRes;
      _AX = 7;
      asm int 0x33;

      _CX =   0;                  // Defines Vertical resolution
      _DX = wVerRes;
      _AX = 8;
      asm int 0x33;

      _ES = FP_SEG( TextMode );
      _DX = FP_OFF( TextMode );
      _CX = 0x7F;                 // When moves, Button Pressed or Button Released
      _AX = 0x000C;               // Event handler
      asm int 0x33;
   }
}

//----------------------------------------------------------------------------

void MouseOn( BYTE bSelCursor )
{
   WORD wRow, wCol;
   BYTE  bVer, bHor;

   bCursor = IF( bSelCursor > 0, bSelCursor - 1, bCursor );

   if( ! bInit )
      MouseInit( 0 );

   if( ! bInstaled )
      return;

   if( ! bWorking )
   {
      bWorking = TRUE;

      if( ! bOnOff )
      {
         bOffs = bOffs ? ( bOffs - 1 ): 0;

         if( ! bOffs )
         {
            bOnOff = TRUE;

            if( bEga )
            {
               _AX = 3;
               asm int 0x33;
               wNewRow    = _DX;
               wNewCol    = _CX;
               wNewButton = 0;

               wRow = IF( wNewRow >= pHots[ bCursor ][ 0 ], wNewRow - pHots[ bCursor ][ 0 ], 0 );
               wCol = IF( wNewCol >= pHots[ bCursor ][ 1 ], wNewCol - pHots[ bCursor ][ 1 ], 0 );

               bVer  = ( wRow / 8 ) % bCharHeigth;
               bHor  = ( wCol / 8 ) % 9;
               wRow /= ( 8 * bCharHeigth );
               wCol /= ( 8 * 9 );

               CursorMix( bVer, bHor,
                          0,
                          TextVideo() + ( wRow * wLineWidth ) + ( wCol * 2 ),
                          FALSE );

               wRowOld = wRow;
               wColOld = wCol;
            }
            else
            {
               _AX = 0x0001;
               asm int 0x33;
            }
         }
      }
      bWorking = FALSE;
   }
}

//---------------------------------------------------------------------------//

// Deja el Flag Working puesto.....

void SetMouseData( LPBYTE bScrImage )
{
   WORD wRow, wCol;
   BYTE  bVer, bHor;

   if( ! bInit )
      MouseInit( 0 );

   if( ! bInstaled )
      return;

   while( bWorking );

   bWorking = TRUE;

   if( bEga && bOnOff )
   {
       _AX = 3;
       asm int 0x33;
       wRow = _DX;
       wCol = _CX;
       wRow = IF( wRow >= pHots[ bCursor ][ 0 ], wRow - pHots[ bCursor ][ 0 ], 0 );
       wCol = IF( wCol >= pHots[ bCursor ][ 1 ], wCol - pHots[ bCursor ][ 1 ], 0 );

       bVer  = ( wRow / 8 ) % bCharHeigth;
       bHor  = ( wCol / 8 ) % 9;
       wRow /= ( 8 * bCharHeigth );
       wCol /= ( 8 * 9 );

       CursorMix( bVer, bHor,
                  0,
                  bScrImage + ( wRow * wLineWidth ) + ( wCol * 2 ),
                  FALSE );

       wRowOld = wRow;
       wColOld = wCol;
   }
}

//---------------------------------------------------------------------------//

void MouseRelease( void )
{
   if( bWorking )
        bWorking = FALSE;
}

//---------------------------------------------------------------------------//

void MouseOff( void )
{
   LPBYTE pVideo = TextVideo();

   if( ! bInstaled )
      return;

   while( bWorking );

   bWorking = TRUE;
   if( bOnOff )
   {
      bOnOff = FALSE;

      if( bEga )
      {
         LPBYTE pMText = pVideo + ( wRowOld * wLineWidth ) + ( wColOld * 2 );

         pMText[ 0 ] = Back[ 0 ];
         pMText[ 2 ] = Back[ 1 ];
         pMText[ 4 ] = Back[ 2 ];
         pMText +=  wLineWidth;
         pMText[ 0 ] = Back[ 3 ];
         pMText[ 2 ] = Back[ 4 ];
         pMText[ 4 ] = Back[ 5 ];
      }
      else
      {
         _AX = 2;
         asm int 0x33;
      }
   }
   bOffs++;
   bWorking = FALSE;
}

//---------------------------------------------------------------------------//

BYTE bMouseRow() { return bRow; }
BYTE bMouseCol() { return bCol; }

//---------------------------------------------------------------------------//

void MouseUpdate()  // Actualiza los valores del rat¢n
{

   if( ! bInstaled )
      return;

   while( bWorking );

   bWorking = TRUE;

   if( bEga )
   {
      bRow = ( wNewRow ) / ( bCharHeigth * 8 );
      bCol = ( wNewCol + 06 ) / ( 9 * 8 );
   }
   else
   {
      bRow = ( wNewRow ) / 8;
      bCol = ( wNewCol ) / 8;
   }

   bLeft   = wNewButton & 1;
   bRight  = wNewButton & 2;
   bCenter = wNewButton & 4;

   bWorking = FALSE;
}

// ----------------------------------------------------------------------------

BOOL bMouseLeft( void )    { return bLeft; }
BOOL bMouseRight( void )   { return bRight; }
BOOL bMouseCenter( void )  { return bCenter; }
BOOL bMousePressed( void ) { return ( bLeft || bRight || bCenter ); }

// ----------------------------------------------------------------------------

void MouseKeyLeft( WORD wKey )   { wKLeft   = wKey; }
void MouseKeyCenter( WORD wKey ) { wKCenter = wKey; }
void MouseKeyRight( WORD wKey )  { wKRight  = wKey; }

// ----------------------------------------------------------------------------

void MouseChars( LPBYTE szMouseChars )
{
  _bcopy( bChars, szMouseChars, 6 );
}

//----------------------------------------------------------------------------//

void MouseSetArea( WORD wTop, WORD wLeft, WORD wBottom, WORD wRight )
{
   _AX = 8;
   _CX = wTop;
   _DX = wBottom;
   asm int 0x33;

   _AX = 7;
   _CX = wLeft;
   _DX = wRight;
   asm int 0x33;
}

//----------------------------------------------------------------------------//

void MouseSetCursor( WORD wCursor )
{
   if( ( wCursor - 1 ) != bCursor )
   {
      MouseOff();
      MouseOn( wCursor );
   }
}

//----------------------------------------------------------------------------//

void MouseSetPos( WORD wRow, WORD wCol )
{
   WORD wGrafRow, wGrafCol;

   if( bEga )
   {
       wGrafRow = wRow * bCharHeigth * 8;
       wGrafCol = wCol * 9 * 8;
       _DX = wGrafRow;
       _CX = wGrafCol;
   }
   else
   {
      _CX = wCol;
      _DX = wRow;
   }
   _AX = 4;
   asm int 0x33;
}

//----------------------------------------------------------------------------//

